<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Churn Dashboard (CRISP-DM)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .tab-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 h-screen flex overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md hidden md:flex flex-col z-10">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-2xl font-bold text-blue-600">
                <i class="fas fa-chart-line mr-2"></i>Churn AI
            </h1>
            <p class="text-xs text-gray-500 mt-1">CRISP-DM Pipeline</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('predict')" id="nav-predict"
                class="tab-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 transition active text-gray-600">
                <i class="fas fa-user-check w-6 text-center"></i> Dự đoán (Predict)
            </button>
            <button onclick="switchTab('analytics')" id="nav-analytics"
                class="tab-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 transition text-gray-600">
                <i class="fas fa-chart-bar w-6 text-center"></i> Analytics & Sales
            </button>
            <button onclick="switchTab('training')" id="nav-training"
                class="tab-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 transition text-gray-600">
                <i class="fas fa-cogs w-6 text-center"></i> Huấn luyện (Train)
            </button>
            <button onclick="switchTab('eda')" id="nav-eda"
                class="tab-btn w-full text-left px-4 py-3 rounded-lg hover:bg-blue-50 transition text-gray-600">
                <i class="fas fa-search-dollar w-6 text-center"></i> Phân tích (EDA)
            </button>
        </nav>
        <div class="p-4 border-t border-gray-100">
            <div id="api-status" class="flex items-center text-sm text-red-500">
                <span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span> API Offline
            </div>
            <div id="model-status" class="flex items-center text-sm text-gray-500 mt-1">
                <i class="fas fa-box mr-2"></i> Model: Unknown
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-y-auto">
        <!-- Mobile Header -->
        <header class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-20">
            <span class="font-bold text-blue-600">Churn AI</span>
            <div class="space-x-4">
                <button onclick="switchTab('predict')">
                    <i class="fas fa-user-check"></i>
                </button>
                <button onclick="switchTab('analytics')">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button onclick="switchTab('training')">
                    <i class="fas fa-cogs"></i>
                </button>
                <button onclick="switchTab('eda')">
                    <i class="fas fa-chart-pie"></i>
                </button>
            </div>
        </header>

        <div class="p-6 md:p-10 max-w-7xl mx-auto w-full">
            <!-- Message Box -->
            <div id="message-box" class="hidden mb-4 p-4 rounded-lg shadow-sm"></div>

            <!-- SECTION: PREDICT -->
            <section id="tab-predict" class="tab-content space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    Dự đoán Khách hàng Rời bỏ
                </h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Form -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <form id="predict-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tuổi (Age)</label>
                                <input type="number" name="Age" value="30"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                                    required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Giới tính (Gender)</label>
                                <select name="Gender"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                                    <option value="Female">Nữ (Female)</option>
                                    <option value="Male">Nam (Male)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Thâm niên (Tenure -
                                    tháng)</label>
                                <input type="number" name="Tenure" value="12"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tần suất sử dụng (Usage
                                    Freq)</label>
                                <input type="number" name="Usage_Frequency" value="5"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Cuộc gọi hỗ trợ (Support
                                    Calls)</label>
                                <input type="number" name="Support_Calls" value="2"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Trễ thanh toán (Payment
                                    Delay)</label>
                                <input type="number" name="Payment_Delay" value="0"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Loại đăng ký
                                    (Subscription)</label>
                                <select name="Subscription_Type"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="Basic">Basic</option>
                                    <option value="Standard">Standard</option>
                                    <option value="Premium">Premium</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Hợp đồng (Contract
                                    Length)</label>
                                <select name="Contract_Length"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="Monthly">Hàng tháng (Monthly)</option>
                                    <option value="Quarterly">Hàng quý (Quarterly)</option>
                                    <option value="Annual">Hàng năm (Annual)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tổng chi tiêu (Total
                                    Spend)</label>
                                <input type="number" name="Total_Spend" value="500" step="0.01"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tương tác cuối (Last
                                    Interaction)</label>
                                <input type="number" name="Last_Interaction" value="5"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    required />
                            </div>

                            <div class="md:col-span-2 mt-4">
                                <button type="submit"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition transform hover:scale-105">
                                    <i class="fas fa-magic mr-2"></i> Dự đoán ngay
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Result -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-full flex flex-col justify-center items-center text-center"
                            id="prediction-result">
                            <div class="text-gray-400 mb-4">
                                <i class="fas fa-robot text-6xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-500">
                                Kết quả dự đoán sẽ hiện ở đây
                            </h3>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION: ANALYTICS -->
            <section id="tab-analytics" class="tab-content hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">
                        Thống kê & Doanh số
                    </h2>
                    <button onclick="loadAnalytics()"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow">
                        <i class="fas fa-sync mr-2"></i> Cập nhật
                    </button>
                </div>

                <!-- Error Alert for Analytics -->
                <div id="analytics-error"
                    class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
                    role="alert">
                    <strong class="font-bold">Lỗi!</strong>
                    <span class="block sm:inline" id="analytics-error-msg"></span>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div
                        class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Tổng Doanh Thu</p>
                            <h3 id="kpi-revenue" class="text-2xl font-bold text-gray-800">
                                Loading...
                            </h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                            <i class="fas fa-dollar-sign text-xl"></i>
                        </div>
                    </div>
                    <div
                        class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500 flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Tổng Khách Hàng</p>
                            <h3 id="kpi-users" class="text-2xl font-bold text-gray-800">
                                Loading...
                            </h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full text-green-600">
                            <i class="fas fa-users text-xl"></i>
                        </div>
                    </div>
                    <div
                        class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500 flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Doanh thu TB (ARPU)</p>
                            <h3 id="kpi-arpu" class="text-2xl font-bold text-gray-800">
                                Loading...
                            </h3>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-full text-orange-600">
                            <i class="fas fa-chart-line text-xl"></i>
                        </div>
                    </div>
                    <div
                        class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500 flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Tỷ lệ Rời bỏ</p>
                            <h3 id="kpi-churn-rate" class="text-2xl font-bold text-gray-800">
                                Loading...
                            </h3>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full text-red-600">
                            <i class="fas fa-door-open text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Analytics Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="text-md font-semibold text-gray-700 mb-4">
                            Doanh thu theo Gói cước
                        </h4>
                        <div class="relative h-64 w-full">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="text-md font-semibold text-gray-700 mb-4">
                            Khách hàng theo Hợp đồng
                        </h4>
                        <div class="relative h-64 w-full">
                            <canvas id="contractChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
                        <h4 class="text-md font-semibold text-gray-700 mb-4">
                            Chi tiêu trung bình: Khách Rời bỏ vs Trung thành
                        </h4>
                        <div class="relative h-64 w-full">
                            <canvas id="churnSpendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION: TRAINING -->
            <section id="tab-training" class="tab-content hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Huấn luyện Mô hình</h2>
                    <button onclick="trainModel()" id="btn-train"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow transition">
                        <i class="fas fa-sync mr-2"></i> Train Model
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">
                        Kết quả đánh giá (Latest Run)
                    </h3>
                    <div id="training-logs"
                        class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-64 overflow-y-auto whitespace-pre-wrap">
                        Chưa có dữ liệu training... Nhấn nút Train Model để bắt đầu.
                    </div>
                </div>
            </section>

            <!-- SECTION: EDA -->
            <section id="tab-eda" class="tab-content hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">
                        Phân tích Dữ liệu (EDA)
                    </h2>
                    <!-- THÊM: type="button" để ngăn hành vi reload trang mặc định -->
                    <button type="button" onclick="loadEDA()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow">
                        <i class="fas fa-redo mr-2"></i> Làm mới
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Chart 1: Target Dist -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="text-md font-semibold text-gray-700 mb-4">
                            Phân phối nhãn (Churn vs No Churn)
                        </h4>
                        <div class="relative h-64 w-full">
                            <canvas id="churnChart"></canvas>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">
                            Tỷ lệ mất cân bằng dữ liệu
                        </p>
                    </div>

                    <!-- Chart 2: Correlations -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="text-md font-semibold text-gray-700 mb-4">
                            Top Yếu tố ảnh hưởng (Correlation)
                        </h4>
                        <div class="relative h-64 w-full">
                            <canvas id="corrChart"></canvas>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">
                            Giá trị dương: Tăng nguy cơ rời bỏ
                        </p>
                    </div>

                    <!-- Chart 3: Churn Rate by Category -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 md:col-span-2">
                        <h4 class="text-md font-semibold text-gray-700 mb-4">
                            Tỷ lệ Rời bỏ theo Hợp đồng & Gói cước (%)
                        </h4>
                        <div class="relative h-64 w-full">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>

                    <!-- Chart 4: Numerical Dist -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 md:col-span-2">
                        <h4 class="text-md font-semibold text-gray-700 mb-4">
                            Phân bổ Khách hàng theo Thâm niên (Tenure)
                        </h4>
                        <div class="relative h-64 w-full">
                            <canvas id="tenureChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p class="text-gray-700 font-semibold" id="loading-text">
                Đang xử lý...
            </p>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const API_URL = 'http://127.0.0.1:8000';

        // --- STATE MANAGEMENT ---
        let charts = {};

        // --- UTILS ---
        function showLoading(text) {
            document.getElementById('loading-text').innerText = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showMessage(msg, type = 'info') {
            const box = document.getElementById('message-box');
            box.classList.remove(
                'hidden',
                'bg-green-100',
                'text-green-800',
                'bg-red-100',
                'text-red-800'
            );

            if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-800');
                box.innerHTML = `<i class="fas fa-check-circle mr-2"></i> ${msg}`;
            } else if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-800');
                box.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> ${msg}`;
            }

            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 5000);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(value);
        }

        function destroyChart(id) {
            if (charts[id]) {
                charts[id].destroy();
                charts[id] = null;
            }
        }

        function switchTab(tabId) {
            document
                .querySelectorAll('.tab-content')
                .forEach((el) => el.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach((el) => {
                el.classList.remove(
                    'bg-blue-50',
                    'text-blue-600',
                    'border-r-4',
                    'border-blue-600'
                );
                el.classList.add('text-gray-600');
            });

            const activeBtn = document.getElementById(`nav-${tabId}`);
            if (activeBtn) {
                activeBtn.classList.add(
                    'bg-blue-50',
                    'text-blue-600',
                    'border-r-4',
                    'border-blue-600'
                );
                activeBtn.classList.remove('text-gray-600');
            }

            if (tabId === 'eda') loadEDA();
            if (tabId === 'analytics') loadAnalytics();
        }

        // --- API CALLS ---

        async function checkStatus() {
            try {
                const res = await fetch(`${API_URL}/status`);
                const data = await res.json();

                const statusEl = document.getElementById('api-status');
                const modelEl = document.getElementById('model-status');

                statusEl.className =
                    'flex items-center text-sm text-green-500 font-bold';
                statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> API Online`;

                if (data.model_trained) {
                    modelEl.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-500"></i> Model: Ready`;
                } else {
                    modelEl.innerHTML = `<i class="fas fa-times-circle mr-2 text-yellow-500"></i> Model: Not Trained`;
                }
            } catch (err) {
                console.error(err);
                const statusEl = document.getElementById('api-status');
                statusEl.className =
                    'flex items-center text-sm text-red-500 font-bold';
                statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span> API Offline`;
            }
        }

        async function trainModel() {
            showLoading('Đang huấn luyện mô hình... Vui lòng chờ.');
            try {
                const res = await fetch(`${API_URL}/train`, { method: 'POST' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Training failed');

                document.getElementById('training-logs').innerHTML =
                    'Training Completed Successfully!\n\n' +
                    JSON.stringify(data.results, null, 2);
                showMessage('Huấn luyện thành công!', 'success');
                checkStatus();
            } catch (err) {
                showMessage(`Lỗi training: ${err.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadAnalytics() {
            document.getElementById('analytics-error').classList.add('hidden');
            showLoading('Đang tải phân tích kinh doanh...');
            try {
                const res = await fetch(`${API_URL}/analytics`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();

                document.getElementById('kpi-revenue').innerText = formatCurrency(
                    data.kpi.total_revenue
                );
                document.getElementById('kpi-users').innerText =
                    data.kpi.total_customers.toLocaleString();
                document.getElementById('kpi-arpu').innerText = formatCurrency(
                    data.kpi.avg_revenue_per_user
                );
                document.getElementById('kpi-churn-rate').innerText =
                    data.kpi.churn_rate.toFixed(1) + '%';

                renderRevenueChart(data.charts.revenue_by_subscription);
                renderContractChart(data.charts.customer_by_contract);
                renderChurnSpendChart(data.charts.avg_spend_churn_vs_loyal);
            } catch (err) {
                document.getElementById('analytics-error').classList.remove('hidden');
                document.getElementById('analytics-error-msg').innerText =
                    err.message;
            } finally {
                hideLoading();
            }
        }

        async function loadEDA() {
            showLoading('Đang tải EDA...');
            try {
                const res = await fetch(`${API_URL}/eda`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();

                if (!data || !data.eda_stats) {
                    throw new Error('Dữ liệu EDA không hợp lệ hoặc thiếu');
                }

                renderEDACharts(data.eda_stats);
                showMessage('Dữ liệu EDA đã được tải thành công!', 'success');
            } catch (err) {
                console.error('EDA Error:', err);
                showMessage('Lỗi tải EDA: ' + err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // --- CHART RENDERERS (ANALYTICS) ---
        function renderRevenueChart(data) {
            destroyChart('revenue');
            charts['revenue'] = new Chart(document.getElementById('revenueChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [
                        {
                            label: 'Doanh thu',
                            data: Object.values(data),
                            backgroundColor: ['#60a5fa', '#34d399', '#a78bfa'],
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                },
            });
        }

        function renderContractChart(data) {
            destroyChart('contract');
            charts['contract'] = new Chart(
                document.getElementById('contractChart'),
                {
                    type: 'pie',
                    data: {
                        labels: Object.keys(data),
                        datasets: [
                            {
                                data: Object.values(data),
                                backgroundColor: ['#f87171', '#fbbf24', '#34d399'],
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right' } },
                    },
                }
            );
        }

        function renderChurnSpendChart(data) {
            destroyChart('spend');
            charts['spend'] = new Chart(
                document.getElementById('churnSpendChart'),
                {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data).map((k) =>
                            k == 1 ? 'Churn' : 'Loyal'
                        ),
                        datasets: [
                            {
                                label: 'Chi tiêu TB',
                                data: Object.values(data),
                                backgroundColor: ['#ef4444', '#10b981'],
                            },
                        ],
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                    },
                }
            );
        }

        // --- CHART RENDERERS (EDA) ---
        function renderEDACharts(stats) {
            // 1. Churn Distribution
            destroyChart('churnDist');
            const distData = stats.target_distribution;
            charts['churnDist'] = new Chart(document.getElementById('churnChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(distData).map((l) =>
                        l == 1 ? 'Churn' : 'Loyal'
                    ),
                    datasets: [
                        {
                            data: Object.values(distData).map((v) => (v * 100).toFixed(1)),
                            backgroundColor: ['#ef4444', '#3b82f6'],
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                },
            });

            // 2. Correlations
            destroyChart('corr');
            const corrData = stats.correlations;
            charts['corr'] = new Chart(document.getElementById('corrChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(corrData),
                    datasets: [
                        {
                            label: 'Hệ số tương quan',
                            data: Object.values(corrData),
                            backgroundColor: Object.values(corrData).map((v) =>
                                v > 0 ? '#f87171' : '#60a5fa'
                            ),
                        },
                    ],
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                },
            });

            // 3. Categorical Churn Rates
            destroyChart('cat');
            const contractChurn = stats.categorical_analysis.churn_by_contract;
            charts['cat'] = new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(contractChurn),
                    datasets: [
                        {
                            label: 'Tỷ lệ Rời bỏ (%)',
                            data: Object.values(contractChurn),
                            backgroundColor: '#fbbf24',
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                },
            });

            // 4. Tenure Distribution
            destroyChart('tenure');
            const tenureData = stats.numerical_distribution.tenure_distribution;
            charts['tenure'] = new Chart(document.getElementById('tenureChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(tenureData),
                    datasets: [
                        {
                            label: 'Số lượng khách hàng',
                            data: Object.values(tenureData),
                            backgroundColor: '#818cf8',
                            tension: 0.4,
                        },
                    ],
                },
                options: { responsive: true, maintainAspectRatio: false },
            });
        }

        // --- FORM HANDLING ---
        document
            .getElementById('predict-form')
            .addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading('Đang dự đoán...');

                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                [
                    'Age',
                    'Tenure',
                    'Usage_Frequency',
                    'Support_Calls',
                    'Payment_Delay',
                    'Total_Spend',
                    'Last_Interaction',
                ].forEach((f) => {
                    if (data[f]) data[f] = parseFloat(data[f]);
                });

                try {
                    const res = await fetch(`${API_URL}/predict`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.detail || 'Prediction failed');

                    const isChurn = result.prediction === 1;
                    const probPercent = (result.churn_probability * 100).toFixed(1);

                    document.getElementById('prediction-result').innerHTML = `
                <div class="mb-2"><i class="fas ${isChurn
                            ? 'fa-exclamation-triangle text-red-500'
                            : 'fa-check-circle text-green-500'
                        } text-6xl animate-bounce"></i></div>
                <h3 class="text-2xl font-bold ${isChurn ? 'text-red-600' : 'text-green-600'
                        }">${isChurn ? 'NGUY CƠ CAO' : 'AN TOÀN'}</h3>
                <div class="mt-4 w-full bg-gray-200 rounded-full h-4"><div class="h-4 rounded-full ${isChurn ? 'bg-red-500' : 'bg-green-500'
                        }" style="width: ${probPercent}%"></div></div>
                <p class="mt-2 text-gray-600 font-semibold">Xác suất: ${probPercent}%</p>
            `;
                } catch (err) {
                    showMessage(err.message, 'error');
                } finally {
                    hideLoading();
                }
            });

        // --- INIT ---
        switchTab('predict');
        document
            .querySelectorAll('button[onclick^="switchTab"]')
            .forEach((btn) => {
                btn.setAttribute('type', 'button');
            });
        checkStatus();
        setInterval(checkStatus, 30000);
    </script>
</body>

</html>